
NATIVE_ENABLED = true
BYTE_ENABLED = true
OCAMLOPTFLAGS = -inline 100
USE_OCAMLFIND = true

.SUBDIRS: ocaml-sqlexpr

OCAMLFLAGS = -thread -w A
OCAMLCFLAGS += -g -annot
OCAMLINCLUDES += ocaml-sqlexpr
OCAML_LIBS[] += ocaml-sqlexpr/sqlexpr

OCAMLPACKS[] =
    csv
    lwt
    lwt.unix
    lwt.syntax
    estring
    batteries
    unix
    str
    sqlite3
    camlp4.macro
    threads
    lwt_comm

section
    OCAML_LIBS[] += ocamlmq
    OCamlProgram(ocamlmq, ocamlmq)

OCAMLFINDFLAGS += -syntax camlp4o

OBJECTS[] =
    binlog
    extSet
    mq_types
    mq_stomp
    mq_server
    mq_sqlite_persistence
    ternary

section
    OCAMLFINDFLAGS += -ppopt ocaml-sqlexpr/pa_sql.cmo
    OCAMLFLAGS += -w -4-27-32
    .SCANNER: scan-ocaml-%.ml: %.ml ocaml-sqlexpr/pa_sql.cmo
    $(addsuffixes .cmi .cmx .cmo .o, mq_sqlite_persistence):

OCamlLibrary(ocamlmq, $(OBJECTS))

section
    OCAMLPACKS[] += oUnit
    TEST_FILES[] = $(removesuffix $(ls test*ml))
    OCamlProgram(test, $(OBJECTS) $(TEST_FILES) test)
    $(addsuffixes .cmi .cmo .cmx .o, $(TEST_FILES) test):

MQ_LIB = $(addsuffixes .cma .cmxa, ocamlmq)
INSTALL_CMIS[] = $(addsuffix .cmi, $(OBJECTS))
INSTALL_FILES[] = META $(INSTALL_CMIS) $(MQ_LIB)

.DEFAULT: ocamlmq$(EXE) $(MQ_LIB)

.PHONY: install
install: META ocamlmq$(EXE) $(INSTALL_FILES)
	ocamlfind install ocamlmq $(INSTALL_FILES)

.PHONY: remove
remove: META
	ocamlfind remove ocamlmq

.PHONY: clean

clean:
	rm -f $(filter-proper-targets $(ls R, .)) *.s
